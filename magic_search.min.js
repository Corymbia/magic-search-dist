try{angular.module("MagicSearch")}catch(exception){angular.module("MagicSearch",[])}angular.module("MagicSearch").directive("magicSearch",function(){return{restrict:"E",scope:{facets_param:"@facets",filter_keys:"=filterKeys",strings:"=strings"},templateUrl:function(a,b){return b.template},controller:function(a,b){a.promptString=a.strings.prompt,a.currentSearch=[],a.initSearch=function(){if("string"==typeof a.facets_param){var b=a.facets_param.replace(/__apos__/g,"'").replace(/__dquote__/g,'\\"').replace(/__bslash__/g,"\\");a.facetsObj=JSON.parse(b)}else a.facetsObj=a.facets_param;a.facetsSave=a.copyFacets(a.facetsObj),a.initFacets()},a.initFacets=function(){var c=window.location.search;0===c.indexOf("?")&&(c=c.slice(1)),c=c.split("&"),(c.length>1||c[0].length>0)&&b(function(){a.strings.prompt=""}),angular.forEach(c,function(b){var c=b.split("=");angular.forEach(a.facetsObj,function(d){d.name==c[0]&&(void 0===d.options?a.currentSearch.push({name:b,label:[d.label,c[1]]}):angular.forEach(d.options,function(e){e.key==c[1]&&(a.currentSearch.push({name:b,label:[d.label,e.label]}),d.singleton===!0?a.deleteFacetEntirely(c):a.deleteFacetSelection(c))}))})}),void 0!==a.textSearch&&a.currentSearch.push({name:"text="+a.textSearch,label:[a.strings.text,a.textSearch]}),a.filteredObj=a.facetsObj},a.copyFacets=function(a){for(var b=[],c=0;c<a.length;c++){var d=Object.create(a[c]);if(void 0!==a[c].options){d.options=[];for(var e=0;e<a[c].options.length;e++)d.options.push(Object.create(a[c].options[e]))}b.push(d)}return b},a.deleteFacetSelection=function(b){angular.forEach(a.facetsObj.slice(),function(c,d){if(c.name==b[0]){if(void 0===c.options)return;for(var e=0;e<c.options.length;e++){var f=c.options[e];f.key==b[1]&&a.facetsObj[d].options.splice(a.facetsObj[d].options.indexOf(f),1)}0===c.options.length&&a.facetsObj.splice(a.facetsObj.indexOf(c),1)}})},a.deleteFacetEntirely=function(b){angular.forEach(a.facetsObj.slice(),function(c){c.name==b[0]&&a.facetsObj.splice(a.facetsObj.indexOf(c),1)})},$(".search-input").on("keydown",function(a){var b=a.keyCode||a.charCode;9==b&&a.preventDefault()}),$(".search-input").on("keyup",function(c){if(1!=c.metaKey){var d=$(".search-input").val(),e=c.keyCode||c.charCode;if(9==e){if(void 0===a.facetSelected){if(1!=a.filteredObj.length)return;a.facetClicked(0,"",a.filteredObj[0].name)}else{if(void 0===a.filteredOptions||1!=a.filteredOptions.length)return;a.optionClicked(0,"",a.filteredOptions[0].key),a.resetState()}return void b(function(){$(".search-input").val("")})}if(27==e){b(function(){a.hideMenu(),$(".search-input").val("")}),a.resetState();var f=a.textSearch;return void 0===f&&(f=""),void a.$emit("textSearch",f,a.filter_keys)}if(13==e){if(a.facetSelected&&void 0===a.facetSelected.options){var g=a.facetSelected;g.name=g.name+"="+d,g.label[1]=d,a.currentSearch.push(g),a.resetState(),a.emitQuery(),a.showMenu()}else{for(i=0;i<a.currentSearch.length;i++)0===a.currentSearch[i].name.indexOf("text")&&a.currentSearch.splice(i,1);a.currentSearch.push({name:"text="+d,label:[a.strings.text,d]}),a.$apply(),a.hideMenu(),$(".search-input").val(""),a.$emit("textSearch",d,a.filter_keys),a.textSearch=d}a.filteredObj=a.facetsObj}else""===d?(a.filteredObj=a.facetsObj,a.$emit("textSearch","",a.filter_keys)):a.filterFacets(d)}}),$(".search-input").on("keypress",function(c){var d=$(".search-input").val(),e=c.which||c.keyCode||c.charCode;return 8!=e&&46!=e&&13!=e&&9!=e&&27!=e&&(d+=String.fromCharCode(e).toLowerCase())," "==d?(a.showMenu(),void b(function(){$(".search-input").val("")})):""===d?(a.filteredObj=a.facetsObj,void a.$emit("textSearch","",a.filter_keys)):void(8!=e&&46!=e&&a.filterFacets(d))}),a.filterFacets=function(c){var d,e,f,g=[];if(void 0===a.facetSelected){for(a.filteredObj=a.facetsObj,d=0;d<a.filteredObj.length;d++){var h=a.filteredObj[d];e=h.label.toLowerCase().indexOf(c),e>-1&&(f=[h.label.substring(0,e),h.label.substring(e,e+c.length),h.label.substring(e+c.length)],g.push({name:h.name,label:f,options:h.options}))}g.length>0?(a.showMenu(),b(function(){a.filteredObj=g},.1)):(a.$emit("textSearch",c,a.filter_keys),a.hideMenu())}else{if(a.filteredOptions=a.facetOptions,void 0===a.facetOptions)return;for(d=0;d<a.filteredOptions.length;d++){var i=a.filteredOptions[d];e=i.label.toLowerCase().indexOf(c),e>-1&&(f=[i.label.substring(0,e),i.label.substring(e,e+c.length),i.label.substring(e+c.length)],g.push({key:i.key,label:f}))}g.length>0&&(a.showMenu(),b(function(){a.filteredOptions=g},.1))}},$(".search-main-area").on("click",function(){$(".search-input").trigger("focus"),void 0===a.facetSelected&&a.showMenu()}),a.facetClicked=function(c){a.hideMenu();var d=a.filteredObj[c],e=d.label;Array.isArray(e)&&(e=e.join("")),a.facetSelected={name:d.name,label:[e,""]},void 0!==d.options&&(a.filteredOptions=a.facetOptions=d.options,a.showMenu()),b(function(){$(".search-input").val("")}),a.strings.prompt="",b(function(){$(".search-input").focus()})},a.optionClicked=function(b,c,d){a.hideMenu();var e=a.facetSelected;e.name=e.name+"="+d,e.label[1]=a.filteredOptions[b].label,Array.isArray(e.label[1])&&(e.label[1]=e.label[1].join("")),a.currentSearch.push(e),a.resetState(),a.emitQuery(),a.showMenu()},a.emitQuery=function(b){for(var c="",d=0;d<a.currentSearch.length;d++)0!==a.currentSearch[d].name.indexOf("text")&&(c.length>0&&(c+="&"),c+=a.currentSearch[d].name);if(void 0!==b&&0===b.indexOf("text"))a.$emit("textSearch","",a.filter_keys),a.textSearch=void 0;else if(a.$emit("searchUpdated",c),a.currentSearch.length>0){var e=a.currentSearch[a.currentSearch.length-1].name,f=e.split("=");angular.forEach(a.facetsSave,function(b){b.name==f[0]&&(b.singleton===!0?a.deleteFacetEntirely(f):a.deleteFacetSelection(f))})}},a.removeFacet=function(b){var c=a.currentSearch[b].name;a.currentSearch.splice(b,1),void 0===a.facetSelected?a.emitQuery(c):(a.resetState(),$(".search-input").val("")),0==a.currentSearch.length&&(a.strings.prompt=a.promptString),a.facetsObj=a.copyFacets(a.facetsSave),a.currentSearch=[],a.initFacets()},a.clearSearch=function(){a.currentSearch.length>0&&(a.currentSearch=[],a.facetsObj=a.copyFacets(a.facetsSave),a.resetState(),a.$emit("searchUpdated",""),a.$emit("textSearch","",a.filter_keys),a.strings.prompt=a.promptString)},a.isMatchLabel=function(a){return Array.isArray(a)},a.resetState=function(){$(".search-input").val(""),a.filteredObj=a.facetsObj,a.facetSelected=void 0,a.facetOptions=void 0,a.filteredOptions=void 0},a.showMenu=function(){b(function(){$("#facet-drop").hasClass("open")===!1&&$(".search-input").trigger("click")})},a.hideMenu=function(){$(document).foundation("dropdown","closeall")},a.initSearch()}}});